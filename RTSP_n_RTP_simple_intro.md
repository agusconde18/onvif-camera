## 关于`RTSP`协议的简要介绍

> 以下的内容是从网络上整理的



`RTSP(Real-Time Stream Protocol)`协议是一个`基于文本`的`多媒体播放控制协议`，属于应用层。
`RTSP`以`客户端`方式工作，对`流媒体`提供**播放**、**暂停**、**后退**、**前进**等_操作_。
该标准由`IETF`指定，对应的协议是`RFC2326`。

从`控制逻辑`上来说`RTSP`和`FTP`相似，流控和数据流是分开的。

`RTSP`在体系结构上位于`RTP`和`RTCP`**之上**，其使用`TCP`或`UDP`完成数据的传输；
`HTTP`与`RTSP`相比，`HTTP`请求由**客户机**发出，服务器作出响应，
使用`RTSP`时，`客户机`和`服务器`都可以**发出请求**，即`RTSP`可以是`双向`的；
`RTSP`是用来`控制声音`或`影像多媒体`**串流协议**，并允许同时多个串流需求控制，
传输时所用的网络通信协定并**不**在其定义范围内。

`RTSP`协议默认端口：`554`，默认承载协议为`TCP`。

`RTSP`作为一个`应用层`协议，提供了一个可供扩展的框架，使得流媒体的受控和点播变得可能，
它主要用来**控制**具有实时特性的数据的发送，但其本身并**不**用于传送流媒体数据，而必须`依赖`下层
`传输协议`(如`RTP/RTCP`)所提供的服务来完成流媒体数据的传送。
`RTSP`负责定义具体的`控制信息`、`操作方法`、`状态码`，以及描述与`RTP`之间的交互操作。

`RTSP`包含`Normal RTSP`(**数据**通过`RTP`传输，应用厂商有苹果和微软等)，
以及`Real-RTSP`(数据通过`RDT`传输)。
在`SpyDroid-IPCamera`当中主要使用`Normal RTSP`,即通过`RTSP`传输视频流的控制信息，视频流数据本身
通过`RTP`协议进行传输.
所以我们目前只分析`Normal RTSP`协议.

`RTSP`传输的一般是`TS`、`MP4`格式的流，其传输一般需要`2~3`个通道，`命令`和`数据`通道`分离`。
使用`RTSP`协议传输流媒体数据需要有专门的`媒体播放器`和`媒体服务器`，也就是需要支持`RTSP`协议的
`客户端`和`服务器`。

![RTSP协议的简单流程](img/rtsp_simple_arch.png)

客户端要播放RTSP媒体流，就需要知道媒体源的URL，RTSP的URL格式一般如下：

`rtsp://host[:port]/[abs_path]/content_name`

`host`: 有效的域名或IP地址；

`port`: 端口号，默认为`554`，若为默认可不填写，否则必须写明。

例如，一个完整的RTSP URL可写为：

`rtsp://192.168.1.67:554/test`

又如目前市面上常用的海康网络摄像头的RTSP地址格式为：

`rtsp://[username]:[password]@[ip]:[port]/[codec]/[channel]/[subtype]/av_stream`

示例： 
`rtsp://admin:12345@192.168.1.67:554/h264/ch1/main/av_stream`

`rtsp://admin:12345@192.168.1.67/mpeg4/ch1/sub/av_stream`

### `RTSP`协议报文

`RTSP`是一种基于`文本`的协议，用`CRLF`(回车换行)作为每一行的`结束符`.
其好处是，在使用过程中可以方便地增加`自定义参数`，也方便`抓包`分析。从消息传送方向上来分，
`RTSP`的报文有两类：**请求报文**和**响应报文**。
请求报文是指从**客户端**向**服务器**发送的请求(也有少量从**服务器**向**客户端**发送的请求)，响应报
文是指从服务器到客户端的回应。

1. `RTSP`请求报文

`RTSP`请求报文的常用方法和作用

| 方法 | 作用 | 
| --- | --- | 
| OPTIONS | 获得服务器提供的可用方法<br>例如:`OPTION`、`DESCRIBE`、`SETUP`、`TEARDOWN`、`PLAY`、`PAUSE`、`SCALE`、`GET_PARAMETER`、`SET_PARAMETER` | 
| DESCRIBE | 得到会话描述信息<br>请求流的`SDP`信息。<br>此处需要了解`H264 Law Data`如何生成`SPS` `PPS`信息。 | 
| SETUP | 客户端请求建立会话,并确立传输模式<br>此处确定了RTP传输交互式采用TCP（面向连接）还是UDP（无连接）模式。 | 
| TEARDOWN | 客户端发起关闭会话请求 | 
| PLAY | 客户端发起播放请求<br>此处引入`RTP`协议及`RTCP`协议。 |
| PAUSE | 播放暂停请求<br>此关键字经常用在录像回放当中，实时视频流几乎用不到。 |  

以下是`RTSP`工作的状态转换图:
![RTSP工作状态转换](img/rtsp_work_route.JPEG)

以下是`RTSP`传输过程的图解:
![RTSP传输过程图解](img/rtsp_transfer_img.JPEG)

`RTSP`中`Client`和`Server`端的交互过程:
![client端和server端交互过程](img/client_negotiate_with_server.JPEG)



----------------------------------------------------

## `RTP`协议简单描述

`RTP`全名是`Real-time Transport Protocol`(实时传输协议)。
它是`IETF`提出的一个标准，对应的`RFC`文档为`RFC3550`(RFC1889为其过期版本)。
`RFC3550`不仅定义了`RTP`，而且定义了配套的相关协议`RTCP(Real-time Transport Control Protocol，即实时传输控制协议)`。
`RTP`用来为IP网上的语音、图像、传真等多种需要实时传输的多媒体数据提供端到端的实时传输服务。
`RTP`为Internet上端到端的实时传输提供时间信息和流同步，但并**不保证**服务质量，服务质量由`RTCP`来提供。

### `RTP`的应用环境

`RTP`用于在`单播`或`多播`网络中传送实时数据。

[RTP报头格式](img/rtp_header.JPEG)

以下是具体的说明:
- 1 `V`：RTP协议的版本号，占2位，当前版本号为2。

- 2 `P`：填充标志，占1位，如果P=1，该报文在尾部填充一个或多个额外的8位组，他们不是有效载荷的一部分。

- 3 `X`：扩展标志，占1位，如果X=1，则在`RTP`报头后面跟一个扩展报头。

- 4 `CC`：`CSRC`技术器，占4位，指示`CSRC`标识的个数。

- 5 `M`：标记，占1位，不同的有效载荷有不同的含义，对于视频标记一帧的结束；对于音频，标记会话的开始。

- 6 同步信源`SSRC`标识符：占32位，用于标识同步信源。该标识符是随机选择的，参加同一视频会议的两个同步信源不能有相同的SSRC。

- 7 特约信源`CSRC`标识符：占32位，可以有0~15个。每个CSRC标识了包含在该RTP报文有效载荷中的所有特约信源。

- 8 PT：有效载荷，占7位，用于说明RTP报文中有效载荷的类型，如AAC，H264等。

- 9 序列号：占16位，用于标识发送者所发送的RTP报文的序列号，每发送一个报文，序号增加1，接收者通过序列号来检测报文丢失情况，重新排列报文，恢复数据。

- 10 时间戳（TimeStamp）：占32位，时间戳反映了该RTP报文的第一个八位组的采样时刻。接受者使用时间戳来计算延迟和抖动，并进行同步控制。


## `RTCP`协议简单描述

`RTCP`的主要功能是：服务质量的`监视`与`反馈`、`媒体间`的**同步**，以及`多播`组中**成员的标识**。
在`RTP`会话期间，各参与者**周期性**地传送`RTCP`包。`RTCP`包中含有`已发送`的数据包的数量、`丢失`的数据包的数量等统计资料，
因此，各参与者可以利用这些信息`动态`地改变**传输速率**，甚至改变**有效载荷类型**。
`RTP`和`RTCP`**配合**使用，它们能以有效的反馈和最小的开销使传输效率最佳化，因而特别适合传送网上的`实时数据`。

### `RTCP`功能描述

1. 提供数据发布的质量反馈

`RTCP`是作为`RTP`传输协议的*一部分*，与其他传输协议的流和`阻塞控制`有关。
反馈对`自适应编码控制`直接起作用，但`IP多播`经验表明，从发送者收到反馈对诊断发送错误是至关重要的。
给所有参加者发送接收反馈报告允许问题观察者估计那些问题是局部的，还是全局的。
诸如`IP多播`等发布机制使网络服务提供商之类的团体可能接收反馈信息，充当`第三方`监控者来诊断网络问题。
反馈功能由`RTCP`**发送者**和**接收者**报告执行。

2. `RTCP`带有称作规范名字(`CNAME`)的`RTP`**源持久传输层标识**
   
如发现冲突，或程序重新启动，既然SSRC标识可改变，接收者需要CNAME跟踪参加者。
接收者也需要CNAME与相关RTP连接中给定的几个数据流联系。

### `RTCP`报文格式

- `SR（Sender Report）`报文：发送者报文。

- `RR（Receiver Report）`报文：接收者报文。

- `SDES（Source Description）`报文：源描述报文。

- `BYE（GoodBye）`报文：退出报文。

- `APP（Application-Defined）`报文：自定义报文


   
























